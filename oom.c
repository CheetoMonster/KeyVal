#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include "KeyVal.h"

/*
oom.c is just to look for memory leaks in KeyVal.
*/


const char *small_str =
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999";

const char *big_str =
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999"
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999";

int main(int argc, char **argv) {

  // create dummy file with one key:
  FILE *fh = fopen("/tmp/c.oom.kv", "w");
  if (!fh) abort();
  fprintf(fh, "`%s` = `%s`\n", small_str, small_str);
  if (fclose(fh)) abort();

  for (int i=0;
      i < 100000;
      ++i) {
    struct KeyVal *kv;
    if (KeyVal_new(&kv)) abort();
    if (KeyVal_load(kv, "/tmp/c.oom.kv")) abort();
    if (KeyVal_setValue(kv, big_str, big_str)) abort();
    char *v;
    if (KeyVal_getValue(&v, kv, big_str, 1)) abort();
    free(v);
    char **arr;
    if (KeyVal_getKeys(&arr, kv, "")) abort();
    // (should be exactly two)
    free(arr[0]);
    free(arr[1]);
    free(arr);

    if (KeyVal_getAllKeys(&arr, kv)) abort();
    free(arr[0]);
    free(arr[1]);
    free(arr);

    if (KeyVal_save(kv, "/tmp/c.oom.kv-out", 1, 1)) abort();

    if (KeyVal_remove(kv, small_str)) abort();
    if (KeyVal_delete(kv)) abort();
  }

  // cleanup:
  unlink("/tmp/c.oom.kv");
  unlink("/tmp/c.oom.kv-out");
  printf("[done]\n");
  return 0;
}


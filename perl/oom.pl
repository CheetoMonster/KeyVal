#! /usr/bin/perl

# perl port of oom.c, to check for memory leaks.

use strict;
use warnings;

use lib qw(perl);
use KeyVal;

my $small_str = 
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999";

my $big_str =
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999".
"0000000000111111111122222222223333333333444444444455555555556666666666777777777788888888889999999999";


# create dummy file with one key:
open(my $fh, q{>}, "/tmp/perl.oom.kv") or die;
print {$fh} "`$small_str` = `$small_str`\n";
close($fh) or die;

for (my $i=0;
      $i < 100000;
      ++$i) {

  my $kv = KeyVal->new();
  $kv->load("/tmp/perl.oom.kv");
  $kv->setValue($big_str, $big_str);
  $kv->getValue($big_str);
  $kv->getKeys("");
  $kv->getAllKeys();
  $kv->save("/tmp/perl.oom.kv-out");
  $kv->remove($small_str);
  $kv->delete();
}

# cleanup:
unlink("/tmp/c.oom.kv");
unlink("/tmp/c.oom.kv-out");
print "[done]\n";
exit 0;

